

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Luffy997">
  <meta name="keywords" content="">
  
    <meta name="description" content="1. æ¦‚è¿°Django QuerySet æ˜¯ Django ORM çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ç°äº†æ•°æ®åº“æŸ¥è¯¢çš„æƒ°æ€§åŠ è½½æœºåˆ¶ã€‚æœ¬æ–‡æ¡£åŸºäº Django 1.11 ç‰ˆæœ¬çš„æºç ï¼Œæ·±å…¥åˆ†æ QuerySet çš„å®ç°åŸç†ã€‚ 1.1 æ–‡ä»¶ä½ç½® ä¸»è¦æºç æ–‡ä»¶ï¼šdjango&#x2F;db&#x2F;models&#x2F;query.py æ ¸å¿ƒç±»ï¼šQuerySetã€ModelIterableã€RelatedPopulator  1.2 è®¾è®¡ç›®æ ‡ æƒ°æ€§æ±‚">
<meta property="og:type" content="article">
<meta property="og:title" content="Django QuerySet">
<meta property="og:url" content="https://luffy997.github.io/2025/07/27/Django-QuerySet/index.html">
<meta property="og:site_name" content="Luffy997&#39;s Blog">
<meta property="og:description" content="1. æ¦‚è¿°Django QuerySet æ˜¯ Django ORM çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ç°äº†æ•°æ®åº“æŸ¥è¯¢çš„æƒ°æ€§åŠ è½½æœºåˆ¶ã€‚æœ¬æ–‡æ¡£åŸºäº Django 1.11 ç‰ˆæœ¬çš„æºç ï¼Œæ·±å…¥åˆ†æ QuerySet çš„å®ç°åŸç†ã€‚ 1.1 æ–‡ä»¶ä½ç½® ä¸»è¦æºç æ–‡ä»¶ï¼šdjango&#x2F;db&#x2F;models&#x2F;query.py æ ¸å¿ƒç±»ï¼šQuerySetã€ModelIterableã€RelatedPopulator  1.2 è®¾è®¡ç›®æ ‡ æƒ°æ€§æ±‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s21.ax1x.com/2025/04/30/pEHJjt1.png">
<meta property="article:published_time" content="2025-07-27T11:53:03.000Z">
<meta property="article:modified_time" content="2026-01-07T14:33:32.901Z">
<meta property="article:author" content="Luffy997">
<meta property="article:tag" content="Django">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://s21.ax1x.com/2025/04/30/pEHJjt1.png">
  
  
  
  <title>Django QuerySet - Luffy997&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"luffy997.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Luffy997çš„åšå®¢</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Django QuerySet"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-07-27 19:53" pubdate>
          2025å¹´7æœˆ27æ—¥ æ™šä¸Š
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          3.5k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          30 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Django QuerySet</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h2><p>Django QuerySet æ˜¯ Django ORM çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ç°äº†æ•°æ®åº“æŸ¥è¯¢çš„æƒ°æ€§åŠ è½½æœºåˆ¶ã€‚æœ¬æ–‡æ¡£åŸºäº Django 1.11 ç‰ˆæœ¬çš„æºç ï¼Œæ·±å…¥åˆ†æ QuerySet çš„å®ç°åŸç†ã€‚</p>
<h3 id="1-1-æ–‡ä»¶ä½ç½®"><a href="#1-1-æ–‡ä»¶ä½ç½®" class="headerlink" title="1.1 æ–‡ä»¶ä½ç½®"></a>1.1 æ–‡ä»¶ä½ç½®</h3><ul>
<li>ä¸»è¦æºç æ–‡ä»¶ï¼š<code>django/db/models/query.py</code></li>
<li>æ ¸å¿ƒç±»ï¼š<code>QuerySet</code>ã€<code>ModelIterable</code>ã€<code>RelatedPopulator</code></li>
</ul>
<h3 id="1-2-è®¾è®¡ç›®æ ‡"><a href="#1-2-è®¾è®¡ç›®æ ‡" class="headerlink" title="1.2 è®¾è®¡ç›®æ ‡"></a>1.2 è®¾è®¡ç›®æ ‡</h3><ul>
<li><strong>æƒ°æ€§æ±‚å€¼</strong>ï¼šåªæœ‰åœ¨çœŸæ­£éœ€è¦æ•°æ®æ—¶æ‰æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢</li>
<li><strong>é“¾å¼æ“ä½œ</strong>ï¼šæ”¯æŒæ–¹æ³•é“¾è°ƒç”¨ï¼Œä¿æŒä»£ç ç®€æ´</li>
<li><strong>ç»“æœç¼“å­˜</strong>ï¼šé¿å…é‡å¤çš„æ•°æ®åº“æŸ¥è¯¢</li>
<li><strong>å†…å­˜ä¼˜åŒ–</strong>ï¼šæ”¯æŒå¤§æ•°æ®é›†çš„é«˜æ•ˆå¤„ç†</li>
</ul>
<h2 id="2-QuerySet-æƒ°æ€§åŠ è½½æœºåˆ¶"><a href="#2-QuerySet-æƒ°æ€§åŠ è½½æœºåˆ¶" class="headerlink" title="2. QuerySet æƒ°æ€§åŠ è½½æœºåˆ¶"></a>2. QuerySet æƒ°æ€§åŠ è½½æœºåˆ¶</h2><h3 id="2-1-æ•´ä½“æµç¨‹å›¾"><a href="#2-1-æ•´ä½“æµç¨‹å›¾" class="headerlink" title="2.1 æ•´ä½“æµç¨‹å›¾"></a>2.1 æ•´ä½“æµç¨‹å›¾</h3><pre><code class=" mermaid">flowchart TD
    A[&quot;åˆ›å»º QuerySet&quot;] --&gt; B&#123;&quot;æ˜¯å¦æœ‰è¿‡æ»¤/æ’åºæ“ä½œ?&quot;&#125;
    B --&gt;|æ˜¯| C[&quot;é“¾å¼æ“ä½œåˆ›å»ºæ–° QuerySet&quot;]
    B --&gt;|å¦| D[&quot;QuerySet å¯¹è±¡å‡†å¤‡å®Œæˆ&quot;]
    C --&gt; D
    D --&gt; E&#123;&quot;æ˜¯å¦è§¦å‘æ±‚å€¼æ“ä½œ?&quot;&#125;
    E --&gt;|å¦| F[&quot;ä¿æŒæƒ°æ€§çŠ¶æ€&lt;br/&gt;_result_cache = None&quot;]
    E --&gt;|æ˜¯| G[&quot;æ£€æŸ¥ _result_cache&quot;]
    G --&gt; H&#123;&quot;ç¼“å­˜æ˜¯å¦ä¸ºç©º?&quot;&#125;
    H --&gt;|å¦| I[&quot;ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ&quot;]
    H --&gt;|æ˜¯| J[&quot;æ‰§è¡Œ _fetch_all&quot;]
    J --&gt; K[&quot;åˆ›å»º SQL ç¼–è¯‘å™¨&quot;]
    K --&gt; L[&quot;æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢&quot;]
    L --&gt; M[&quot;åˆ›å»ºæ¨¡å‹å®ä¾‹&quot;]
    M --&gt; N[&quot;å¤„ç†å…³è”å¯¹è±¡&quot;]
    N --&gt; O[&quot;å­˜å‚¨åˆ° _result_cache&quot;]
    O --&gt; P[&quot;è¿”å›ç»“æœ&quot;]
    
    F --&gt; E
    
    style A fill:#e1f5fe
    style F fill:#fff3e0
    style P fill:#e8f5e8
    style L fill:#ffebee
</code></pre>

<h3 id="2-2-æƒ°æ€§åŠ è½½çš„æ ¸å¿ƒåŸç†"><a href="#2-2-æƒ°æ€§åŠ è½½çš„æ ¸å¿ƒåŸç†" class="headerlink" title="2.2 æƒ°æ€§åŠ è½½çš„æ ¸å¿ƒåŸç†"></a>2.2 æƒ°æ€§åŠ è½½çš„æ ¸å¿ƒåŸç†</h3><p>æƒ°æ€§åŠ è½½é€šè¿‡ä»¥ä¸‹å‡ ä¸ªå…³é”®æœºåˆ¶å®ç°ï¼š</p>
<ol>
<li><strong>å»¶è¿Ÿæ‰§è¡Œ</strong>ï¼šQuerySet åˆ›å»ºæ—¶ä¸æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢</li>
<li><strong>ç»“æœç¼“å­˜</strong>ï¼š<code>_result_cache</code> å±æ€§æ§åˆ¶æŸ¥è¯¢çš„æ‰§è¡Œå’Œç¼“å­˜</li>
<li><strong>è§¦å‘æœºåˆ¶</strong>ï¼šç‰¹å®šæ“ä½œè§¦å‘å®é™…çš„æ•°æ®åº“æŸ¥è¯¢</li>
</ol>
<h2 id="3-æ ¸å¿ƒç±»å’Œæ–¹æ³•åˆ†æ"><a href="#3-æ ¸å¿ƒç±»å’Œæ–¹æ³•åˆ†æ" class="headerlink" title="3. æ ¸å¿ƒç±»å’Œæ–¹æ³•åˆ†æ"></a>3. æ ¸å¿ƒç±»å’Œæ–¹æ³•åˆ†æ</h2><h3 id="3-1-QuerySet-ç±»åˆå§‹åŒ–"><a href="#3-1-QuerySet-ç±»åˆå§‹åŒ–" class="headerlink" title="3.1 QuerySet ç±»åˆå§‹åŒ–"></a>3.1 QuerySet ç±»åˆå§‹åŒ–</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">QuerySet</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model=<span class="hljs-literal">None</span>, query=<span class="hljs-literal">None</span>, using=<span class="hljs-literal">None</span>, hints=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-variable language_">self</span>.model = model<br>        <span class="hljs-variable language_">self</span>._db = using<br>        <span class="hljs-variable language_">self</span>._hints = hints <span class="hljs-keyword">or</span> &#123;&#125;<br>        <span class="hljs-variable language_">self</span>.query = query <span class="hljs-keyword">or</span> sql.Query(<span class="hljs-variable language_">self</span>.model)<br>        <span class="hljs-variable language_">self</span>._result_cache = <span class="hljs-literal">None</span>  <span class="hljs-comment"># ğŸ”‘ å…³é”®ï¼šç»“æœç¼“å­˜åˆå§‹ä¸º None</span><br>        <span class="hljs-variable language_">self</span>._sticky_filter = <span class="hljs-literal">False</span><br>        <span class="hljs-variable language_">self</span>._for_write = <span class="hljs-literal">False</span><br>        <span class="hljs-variable language_">self</span>._prefetch_related_lookups = ()<br>        <span class="hljs-variable language_">self</span>._prefetch_done = <span class="hljs-literal">False</span><br>        <span class="hljs-variable language_">self</span>._known_related_objects = &#123;&#125;<br>        <span class="hljs-variable language_">self</span>._iterable_class = ModelIterable<br>        <span class="hljs-variable language_">self</span>._fields = <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure>

<p><strong>å…³é”®ç‚¹åˆ†æ</strong>ï¼š</p>
<ul>
<li><code>_result_cache = None</code>ï¼šè¿™æ˜¯æƒ°æ€§åŠ è½½çš„æ ¸å¿ƒï¼Œåªæœ‰åœ¨çœŸæ­£éœ€è¦æ•°æ®æ—¶æ‰ä¼šå¡«å……</li>
<li><code>query</code> å¯¹è±¡ï¼šå°è£…äº† SQL æŸ¥è¯¢é€»è¾‘ï¼Œä½†ä¸ç«‹å³æ‰§è¡Œ</li>
<li><code>_iterable_class</code>ï¼šå®šä¹‰äº†å¦‚ä½•å°†æ•°æ®åº“è¡Œè½¬æ¢ä¸ºæ¨¡å‹å®ä¾‹</li>
</ul>
<h3 id="3-2-é“¾å¼æ“ä½œæœºåˆ¶"><a href="#3-2-é“¾å¼æ“ä½œæœºåˆ¶" class="headerlink" title="3.2 é“¾å¼æ“ä½œæœºåˆ¶"></a>3.2 é“¾å¼æ“ä½œæœºåˆ¶</h3><pre><code class=" mermaid">flowchart LR
    A[&quot;User.objects&quot;] --&gt; B[&quot;.filter age__gt=18&quot;]
    B --&gt; C[&quot;æ–° QuerySet 1&lt;br/&gt;ä»ç„¶æƒ°æ€§&quot;]
    C --&gt; D[&quot;.filter name__startswith=&#x27;A&#x27;&quot;]
    D --&gt; E[&quot;æ–° QuerySet 2&lt;br/&gt;ä»ç„¶æƒ°æ€§&quot;]
    E --&gt; F[&quot;.order_by &#x27;id&#x27;&quot;]
    F --&gt; G[&quot;æ–° QuerySet 3&lt;br/&gt;ä»ç„¶æƒ°æ€§&quot;]
    G --&gt; H[&quot;è§¦å‘æ±‚å€¼æ“ä½œ&lt;br/&gt;å¦‚ list, len, forå¾ªç¯&quot;]
    H --&gt; I[&quot;æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢&quot;]
    
    style A fill:#e3f2fd
    style C fill:#fff3e0
    style E fill:#fff3e0
    style G fill:#fff3e0
    style I fill:#ffebee
</code></pre>

<h4 id="filter-æ–¹æ³•å®ç°"><a href="#filter-æ–¹æ³•å®ç°" class="headerlink" title="filter æ–¹æ³•å®ç°"></a>filter æ–¹æ³•å®ç°</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter</span>(<span class="hljs-params">self, *args, **kwargs</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;è¿”å›æ–°çš„ QuerySet å®ä¾‹ï¼Œä¸æ‰§è¡ŒæŸ¥è¯¢&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>._filter_or_exclude(<span class="hljs-literal">False</span>, *args, **kwargs)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_filter_or_exclude</span>(<span class="hljs-params">self, negate, *args, **kwargs</span>):<br>    clone = <span class="hljs-variable language_">self</span>._clone()  <span class="hljs-comment"># ğŸ”‘ å…‹éš†å½“å‰ QuerySet</span><br>    <span class="hljs-keyword">if</span> negate:<br>        clone.query.add_q(~Q(*args, **kwargs))<br>    <span class="hljs-keyword">else</span>:<br>        clone.query.add_q(Q(*args, **kwargs))<br>    <span class="hljs-keyword">return</span> clone  <span class="hljs-comment"># è¿”å›æ–°çš„ QuerySetï¼Œä»ç„¶æƒ°æ€§</span><br></code></pre></td></tr></table></figure>

<p><strong>è®¾è®¡è¦ç‚¹</strong>ï¼š</p>
<ul>
<li>æ¯ä¸ªè¿‡æ»¤æ“ä½œéƒ½è¿”å›æ–°çš„ QuerySet å¯¹è±¡</li>
<li>åŸå§‹ QuerySet ä¿æŒä¸å˜ï¼ˆä¸å¯å˜æ€§ï¼‰</li>
<li>æ–° QuerySet çš„ <code>_result_cache</code> ä»ç„¶ä¸º <code>None</code></li>
</ul>
<h3 id="3-3-è§¦å‘æ±‚å€¼çš„æ“ä½œ"><a href="#3-3-è§¦å‘æ±‚å€¼çš„æ“ä½œ" class="headerlink" title="3.3 è§¦å‘æ±‚å€¼çš„æ“ä½œ"></a>3.3 è§¦å‘æ±‚å€¼çš„æ“ä½œ</h3><pre><code class=" mermaid">flowchart TD
    A[&quot;QuerySet å¯¹è±¡&lt;br/&gt;_result_cache = None&quot;] --&gt; B&#123;&quot;è§¦å‘æ–¹å¼&quot;&#125;
    
    B --&gt;|è¿­ä»£| C[&quot;for item in qs:&lt;br/&gt;__iter__&quot;]
    B --&gt;|é•¿åº¦| D[&quot;len qs&lt;br/&gt;__len__&quot;]
    B --&gt;|å¸ƒå°”å€¼| E[&quot;if qs:&lt;br/&gt;__bool__&quot;]
    B --&gt;|ç´¢å¼•è®¿é—®| F[&quot;qs[0]&lt;br/&gt;__getitem__&quot;]
    B --&gt;|åˆ—è¡¨è½¬æ¢| G[&quot;list qs&quot;]
    B --&gt;|è®¡æ•°| H[&quot;qs.count&quot;]
    B --&gt;|å­˜åœ¨æ€§æ£€æŸ¥| I[&quot;qs.exists&quot;]
    
    C --&gt; J[&quot;è°ƒç”¨ _fetch_all&quot;]
    D --&gt; J
    E --&gt; J
    F --&gt; K&#123;&quot;æ˜¯å¦æœ‰ç¼“å­˜?&quot;&#125;
    G --&gt; J
    H --&gt; L[&quot;ç›´æ¥æ‰§è¡Œ COUNT æŸ¥è¯¢&quot;]
    I --&gt; M[&quot;æ‰§è¡Œ EXISTS æŸ¥è¯¢&quot;]
    
    K --&gt;|æœ‰| N[&quot;ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ&quot;]
    K --&gt;|æ— | O[&quot;åˆ›å»ºé™åˆ¶æŸ¥è¯¢&quot;]
    
    J --&gt; P[&quot;æ‰§è¡Œå®Œæ•´æŸ¥è¯¢&lt;br/&gt;å¡«å…… _result_cache&quot;]
    O --&gt; Q[&quot;æ‰§è¡Œå•æ¡/åˆ‡ç‰‡æŸ¥è¯¢&quot;]
    
    style A fill:#e1f5fe
    style J fill:#fff3e0
    style P fill:#e8f5e8
    style L fill:#e8f5e8
    style M fill:#e8f5e8
</code></pre>

<h4 id="å…³é”®æ–¹æ³•å®ç°"><a href="#å…³é”®æ–¹æ³•å®ç°" class="headerlink" title="å…³é”®æ–¹æ³•å®ç°"></a>å…³é”®æ–¹æ³•å®ç°</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;è¿­ä»£å™¨åè®®å®ç°&quot;&quot;&quot;</span><br>    <span class="hljs-variable language_">self</span>._fetch_all()  <span class="hljs-comment"># ğŸ”‘ è§¦å‘å®é™…çš„æ•°æ®åº“æŸ¥è¯¢</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">iter</span>(<span class="hljs-variable language_">self</span>._result_cache)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;é•¿åº¦è®¡ç®—&quot;&quot;&quot;</span><br>    <span class="hljs-variable language_">self</span>._fetch_all()<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>._result_cache)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__bool__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;å¸ƒå°”å€¼åˆ¤æ–­&quot;&quot;&quot;</span><br>    <span class="hljs-variable language_">self</span>._fetch_all()<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bool</span>(<span class="hljs-variable language_">self</span>._result_cache)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, k</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;ç´¢å¼•/åˆ‡ç‰‡è®¿é—®&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._result_cache <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>._result_cache[k]  <span class="hljs-comment"># å¦‚æœå·²æœ‰ç¼“å­˜ï¼Œç›´æ¥è¿”å›</span><br>    <br>    <span class="hljs-comment"># åˆ‡ç‰‡æ“ä½œï¼šåˆ›å»ºæ–° QuerySet è€Œä¸æ˜¯æ‰§è¡ŒæŸ¥è¯¢</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(k, <span class="hljs-built_in">slice</span>):<br>        qs = <span class="hljs-variable language_">self</span>._clone()<br>        qs.query.set_limits(k.start, k.stop)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(qs)[::k.step] <span class="hljs-keyword">if</span> k.step <span class="hljs-keyword">else</span> qs<br>    <br>    <span class="hljs-comment"># å•ä¸ªå…ƒç´ è®¿é—®</span><br>    qs = <span class="hljs-variable language_">self</span>._clone()<br>    qs.query.set_limits(k, k + <span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(qs)[<span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure>

<h3 id="3-4-fetch-all-æ ¸å¿ƒæ–¹æ³•"><a href="#3-4-fetch-all-æ ¸å¿ƒæ–¹æ³•" class="headerlink" title="3.4 _fetch_all æ ¸å¿ƒæ–¹æ³•"></a>3.4 _fetch_all æ ¸å¿ƒæ–¹æ³•</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_fetch_all</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;æƒ°æ€§åŠ è½½çš„æ ¸å¿ƒå®ç°&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._result_cache <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:  <span class="hljs-comment"># ğŸ”‘ åªæœ‰ç¼“å­˜ä¸ºç©ºæ—¶æ‰æ‰§è¡ŒæŸ¥è¯¢</span><br>        <span class="hljs-variable language_">self</span>._result_cache = <span class="hljs-built_in">list</span>(<span class="hljs-variable language_">self</span>._iterable_class(<span class="hljs-variable language_">self</span>))<br>    <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._prefetch_related_lookups <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>._prefetch_done:<br>        <span class="hljs-variable language_">self</span>._prefetch_related_objects()<br></code></pre></td></tr></table></figure>

<h4 id="æ‰§è¡Œæµç¨‹æ—¶åºå›¾"><a href="#æ‰§è¡Œæµç¨‹æ—¶åºå›¾" class="headerlink" title="æ‰§è¡Œæµç¨‹æ—¶åºå›¾"></a>æ‰§è¡Œæµç¨‹æ—¶åºå›¾</h4><pre><code class=" mermaid">sequenceDiagram
    participant User as &quot;ç”¨æˆ·ä»£ç &quot;
    participant QS as &quot;QuerySet&quot;
    participant Iter as &quot;ModelIterable&quot;
    participant Comp as &quot;SQL Compiler&quot;
    participant DB as &quot;æ•°æ®åº“&quot;
    participant Model as &quot;Model å®ä¾‹&quot;

    User-&gt;&gt;QS: &quot;è§¦å‘æ±‚å€¼æ“ä½œ å¦‚ for å¾ªç¯&quot;
    QS-&gt;&gt;QS: &quot;æ£€æŸ¥ _result_cache&quot;
    
    alt &quot;_result_cache ä¸º None&quot;
        QS-&gt;&gt;QS: &quot;è°ƒç”¨ _fetch_all&quot;
        QS-&gt;&gt;Iter: &quot;åˆ›å»º ModelIterable&quot;
        Iter-&gt;&gt;Comp: &quot;query.get_compiler&quot;
        Comp-&gt;&gt;DB: &quot;execute_sql&quot;
        DB--&gt;&gt;Comp: &quot;è¿”å›åŸå§‹æ•°æ®è¡Œ&quot;
        
        loop &quot;å¤„ç†æ¯ä¸€è¡Œæ•°æ®&quot;
            Comp-&gt;&gt;Model: &quot;model_cls.from_db&quot;
            Model--&gt;&gt;Comp: &quot;è¿”å›æ¨¡å‹å®ä¾‹&quot;
            Comp-&gt;&gt;Comp: &quot;å¤„ç†å…³è”å¯¹è±¡å’Œæ³¨è§£&quot;
        end
        
        Iter--&gt;&gt;QS: &quot;è¿”å›æ¨¡å‹å®ä¾‹åˆ—è¡¨&quot;
        QS-&gt;&gt;QS: &quot;å­˜å‚¨åˆ° _result_cache&quot;
    else &quot;_result_cache å·²å­˜åœ¨&quot;
        QS-&gt;&gt;QS: &quot;ç›´æ¥ä½¿ç”¨ç¼“å­˜&quot;
    end
    
    QS--&gt;&gt;User: &quot;è¿”å›ç»“æœ&quot;
</code></pre>

<h3 id="3-5-ModelIterable-ç±»åˆ†æ"><a href="#3-5-ModelIterable-ç±»åˆ†æ" class="headerlink" title="3.5 ModelIterable ç±»åˆ†æ"></a>3.5 ModelIterable ç±»åˆ†æ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelIterable</span>(<span class="hljs-title class_ inherited__">BaseIterable</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;ä¸ºæ¯ä¸€è¡Œç”Ÿæˆä¸€ä¸ªæ¨¡å‹å®ä¾‹&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):<br>        queryset = <span class="hljs-variable language_">self</span>.queryset<br>        db = queryset.db<br>        compiler = queryset.query.get_compiler(using=db)<br>        <br>        <span class="hljs-comment"># æ‰§è¡ŒæŸ¥è¯¢ï¼Œè¿™é‡Œæ‰çœŸæ­£è®¿é—®æ•°æ®åº“</span><br>        results = compiler.execute_sql(chunked_fetch=<span class="hljs-variable language_">self</span>.chunked_fetch)<br>        <br>        <span class="hljs-comment"># è·å–é€‰æ‹©å­—æ®µã€ç±»ä¿¡æ¯ç­‰</span><br>        select, klass_info, annotation_col_map = (<br>            compiler.select, compiler.klass_info, compiler.annotation_col_map<br>        )<br>        model_cls = klass_info[<span class="hljs-string">&#x27;model&#x27;</span>]<br>        select_fields = klass_info[<span class="hljs-string">&#x27;select_fields&#x27;</span>]<br>        model_fields_start, model_fields_end = select_fields[<span class="hljs-number">0</span>], select_fields[-<span class="hljs-number">1</span>] + <span class="hljs-number">1</span><br>        init_list = [f[<span class="hljs-number">0</span>].target.attname<br>                     <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> select[model_fields_start:model_fields_end]]<br>        <br>        <span class="hljs-comment"># è·å–å…³è”å¯¹è±¡å¡«å……å™¨</span><br>        related_populators = get_related_populators(klass_info, select, db)<br>        <br>        <span class="hljs-comment"># é€è¡Œå¤„ç†ç»“æœï¼Œåˆ›å»ºæ¨¡å‹å®ä¾‹</span><br>        <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> compiler.results_iter(results):<br>            obj = model_cls.from_db(db, init_list, row[model_fields_start:model_fields_end])<br>            <br>            <span class="hljs-comment"># å¤„ç†å…³è”å¯¹è±¡</span><br>            <span class="hljs-keyword">if</span> related_populators:<br>                <span class="hljs-keyword">for</span> rel_populator <span class="hljs-keyword">in</span> related_populators:<br>                    rel_populator.populate(row, obj)<br>                    <br>            <span class="hljs-comment"># å¤„ç†æ³¨è§£å­—æ®µ</span><br>            <span class="hljs-keyword">if</span> annotation_col_map:<br>                <span class="hljs-keyword">for</span> attr_name, col_pos <span class="hljs-keyword">in</span> annotation_col_map.items():<br>                    <span class="hljs-built_in">setattr</span>(obj, attr_name, row[col_pos])<br><br>            <span class="hljs-comment"># å¤„ç†å·²çŸ¥çš„å…³è”å¯¹è±¡</span><br>            <span class="hljs-keyword">if</span> queryset._known_related_objects:<br>                <span class="hljs-keyword">for</span> field, rel_objs <span class="hljs-keyword">in</span> queryset._known_related_objects.items():<br>                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(obj, field.get_cache_name()):<br>                        <span class="hljs-keyword">continue</span><br>                    pk = <span class="hljs-built_in">getattr</span>(obj, field.get_attname())<br>                    <span class="hljs-keyword">try</span>:<br>                        rel_obj = rel_objs[pk]<br>                    <span class="hljs-keyword">except</span> KeyError:<br>                        <span class="hljs-keyword">pass</span><br>                    <span class="hljs-keyword">else</span>:<br>                        <span class="hljs-built_in">setattr</span>(obj, field.name, rel_obj)<br><br>            <span class="hljs-keyword">yield</span> obj  <span class="hljs-comment"># ğŸ”‘ ç”Ÿæˆå™¨æ¨¡å¼ï¼Œé€ä¸ªè¿”å›å¯¹è±¡</span><br></code></pre></td></tr></table></figure>

<p><strong>å…³é”®ç‰¹æ€§</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ç”Ÿæˆå™¨æ¨¡å¼ï¼Œå†…å­˜æ•ˆç‡é«˜</li>
<li>æ”¯æŒåˆ†å—è·å–æ•°æ®ï¼ˆ<code>chunked_fetch</code>ï¼‰</li>
<li>è‡ªåŠ¨å¤„ç†å…³è”å¯¹è±¡å’Œæ³¨è§£å­—æ®µ</li>
</ul>
<h2 id="4-æµç¨‹å›¾è¯¦è§£"><a href="#4-æµç¨‹å›¾è¯¦è§£" class="headerlink" title="4. æµç¨‹å›¾è¯¦è§£"></a>4. æµç¨‹å›¾è¯¦è§£</h2><h3 id="4-1-QuerySet-çŠ¶æ€å˜åŒ–"><a href="#4-1-QuerySet-çŠ¶æ€å˜åŒ–" class="headerlink" title="4.1 QuerySet çŠ¶æ€å˜åŒ–"></a>4.1 QuerySet çŠ¶æ€å˜åŒ–</h3><pre><code class=" mermaid">stateDiagram-v2
    [*] --&gt; Created: &quot;åˆ›å»º QuerySet&quot;
    Created --&gt; Filtered: &quot;æ·»åŠ è¿‡æ»¤æ¡ä»¶&quot;
    Filtered --&gt; Filtered: &quot;é“¾å¼æ“ä½œ&quot;
    Filtered --&gt; Evaluated: &quot;è§¦å‘æ±‚å€¼&quot;
    Created --&gt; Evaluated: &quot;ç›´æ¥æ±‚å€¼&quot;
    Evaluated --&gt; Cached: &quot;ç»“æœå·²ç¼“å­˜&quot;
    Cached --&gt; Cached: &quot;é‡å¤è®¿é—®ç¼“å­˜&quot;
    
    note right of Created
        &quot;_result_cache = None&lt;br/&gt;query å¯¹è±¡å·²åˆ›å»º&quot;
    end note
    
    note right of Filtered
        &quot;ä»ç„¶ _result_cache = None&lt;br/&gt;query å¯¹è±¡è¢«ä¿®æ”¹&quot;
    end note
    
    note right of Evaluated
        &quot;æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢&lt;br/&gt;_fetch_all è¢«è°ƒç”¨&quot;
    end note
    
    note right of Cached
        &quot;_result_cache åŒ…å«ç»“æœ&lt;br/&gt;åç»­è®¿é—®æ— éœ€æŸ¥è¯¢æ•°æ®åº“&quot;
    end note
</code></pre>

<h3 id="4-2-å†…å­˜ä½¿ç”¨ä¼˜åŒ–ç­–ç•¥"><a href="#4-2-å†…å­˜ä½¿ç”¨ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="4.2 å†…å­˜ä½¿ç”¨ä¼˜åŒ–ç­–ç•¥"></a>4.2 å†…å­˜ä½¿ç”¨ä¼˜åŒ–ç­–ç•¥</h3><pre><code class=" mermaid">flowchart TD
    A[&quot;å¤§é‡æ•°æ®æŸ¥è¯¢&quot;] --&gt; B&#123;&quot;é€‰æ‹©è¿­ä»£æ–¹å¼&quot;&#125;
    
    B --&gt;|&quot;ä½¿ç”¨ QuerySet ç›´æ¥è¿­ä»£&quot;| C[&quot;list qs&lt;br/&gt;åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜&quot;]
    B --&gt;|&quot;ä½¿ç”¨ iterator&quot;| D[&quot;qs.iterator&lt;br/&gt;é€æ¡è·å–ï¼Œä½å†…å­˜å ç”¨&quot;]
    B --&gt;|&quot;ä½¿ç”¨ æ‰¹é‡å¤„ç†&quot;| E[&quot;åˆ†æ‰¹å¤„ç†&lt;br/&gt;batch_size å‚æ•°&quot;]
    
    C --&gt; F[&quot;é«˜å†…å­˜ä½¿ç”¨&lt;br/&gt;é€‚åˆå°æ•°æ®é›†&quot;]
    D --&gt; G[&quot;ä½å†…å­˜ä½¿ç”¨&lt;br/&gt;é€‚åˆå¤§æ•°æ®é›†&lt;br/&gt;ä½†ä¸èƒ½é‡å¤è¿­ä»£&quot;]
    E --&gt; H[&quot;å¹³è¡¡å†…å­˜å’Œæ€§èƒ½&lt;br/&gt;å¯æ§åˆ¶æ‰¹æ¬¡å¤§å°&quot;]
    
    style C fill:#ffebee
    style D fill:#e8f5e8
    style E fill:#fff3e0
</code></pre>

<h2 id="5-æ€§èƒ½ä¼˜åŒ–æœºåˆ¶"><a href="#5-æ€§èƒ½ä¼˜åŒ–æœºåˆ¶" class="headerlink" title="5. æ€§èƒ½ä¼˜åŒ–æœºåˆ¶"></a>5. æ€§èƒ½ä¼˜åŒ–æœºåˆ¶</h2><h3 id="5-1-select-related-ä¼˜åŒ–"><a href="#5-1-select-related-ä¼˜åŒ–" class="headerlink" title="5.1 select_related ä¼˜åŒ–"></a>5.1 select_related ä¼˜åŒ–</h3><pre><code class=" mermaid">flowchart TD
    A[&quot;QuerySet.select_related &#x27;foreign_key&#x27;&quot;] --&gt; B[&quot;ä¿®æ”¹ SQL æŸ¥è¯¢æ·»åŠ  JOIN&quot;]
    B --&gt; C[&quot;æ‰§è¡Œå•æ¬¡æ•°æ®åº“æŸ¥è¯¢&quot;]
    C --&gt; D[&quot;è·å–åŒ…å«å…³è”æ•°æ®çš„ç»“æœè¡Œ&quot;]
    D --&gt; E[&quot;åˆ›å»ºä¸»æ¨¡å‹å®ä¾‹&quot;]
    E --&gt; F[&quot;RelatedPopulator.populate&quot;]
    F --&gt; G[&quot;ä»åŒä¸€è¡Œæ•°æ®åˆ›å»ºå…³è”å¯¹è±¡&quot;]
    G --&gt; H[&quot;è®¾ç½®å¯¹è±¡é—´çš„å…³è”å…³ç³»&quot;]
    H --&gt; I[&quot;é¿å…é¢å¤–çš„æ•°æ®åº“æŸ¥è¯¢&quot;]
    
    J[&quot;ä¸ä½¿ç”¨ select_related&quot;] --&gt; K[&quot;åˆ›å»ºä¸»æ¨¡å‹å®ä¾‹&quot;]
    K --&gt; L[&quot;è®¿é—®å…³è”å±æ€§æ—¶&quot;]
    L --&gt; M[&quot;è§¦å‘é¢å¤–çš„æ•°æ®åº“æŸ¥è¯¢&quot;]
    M --&gt; N[&quot;N+1 æŸ¥è¯¢é—®é¢˜&quot;]
    
    style A fill:#e8f5e8
    style I fill:#e8f5e8
    style N fill:#ffebee
</code></pre>

<h4 id="RelatedPopulator-ç±»å®ç°"><a href="#RelatedPopulator-ç±»å®ç°" class="headerlink" title="RelatedPopulator ç±»å®ç°"></a>RelatedPopulator ç±»å®ç°</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RelatedPopulator</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    RelatedPopulator ç”¨äº select_related å¯¹è±¡å®ä¾‹åŒ–ã€‚</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    æ€è·¯æ˜¯æ¯ä¸ª select_related æ¨¡å‹éƒ½ç”±ä¸åŒçš„ RelatedPopulator å®ä¾‹å¡«å……ã€‚</span><br><span class="hljs-string">    RelatedPopulator å®ä¾‹è·å– klass_info å’Œ selectï¼ˆåœ¨ SQLCompiler ä¸­è®¡ç®—ï¼‰</span><br><span class="hljs-string">    ä»¥åŠä½¿ç”¨çš„æ•°æ®åº“ä½œä¸ºåˆå§‹åŒ–è¾“å…¥ã€‚</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, klass_info, select, db</span>):<br>        <span class="hljs-variable language_">self</span>.db = db<br>        <span class="hljs-comment"># é¢„è®¡ç®—éœ€è¦çš„å±æ€§</span><br>        select_fields = klass_info[<span class="hljs-string">&#x27;select_fields&#x27;</span>]<br>        from_parent = klass_info[<span class="hljs-string">&#x27;from_parent&#x27;</span>]<br>        <br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> from_parent:<br>            <span class="hljs-comment"># ç®€å•æƒ…å†µï¼šå­—æ®µé¡ºåºä¸ __init__ æœŸæœ›çš„é¡ºåºç›¸åŒ</span><br>            <span class="hljs-variable language_">self</span>.cols_start = select_fields[<span class="hljs-number">0</span>]<br>            <span class="hljs-variable language_">self</span>.cols_end = select_fields[-<span class="hljs-number">1</span>] + <span class="hljs-number">1</span><br>            <span class="hljs-variable language_">self</span>.init_list = [<br>                f[<span class="hljs-number">0</span>].target.attname <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> select[<span class="hljs-variable language_">self</span>.cols_start:<span class="hljs-variable language_">self</span>.cols_end]<br>            ]<br>            <span class="hljs-variable language_">self</span>.reorder_for_init = <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># å¤æ‚æƒ…å†µï¼šéœ€è¦é‡æ–°æ’åºå­—æ®µæ•°æ®</span><br>            model_init_attnames = [<br>                f.attname <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> klass_info[<span class="hljs-string">&#x27;model&#x27;</span>]._meta.concrete_fields<br>            ]<br>            reorder_map = []<br>            <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> select_fields:<br>                field = select[idx][<span class="hljs-number">0</span>].target<br>                init_pos = model_init_attnames.index(field.attname)<br>                reorder_map.append((init_pos, field.attname, idx))<br>            reorder_map.sort()<br>            <span class="hljs-variable language_">self</span>.init_list = [v[<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> reorder_map]<br>            pos_list = [row_pos <span class="hljs-keyword">for</span> _, _, row_pos <span class="hljs-keyword">in</span> reorder_map]<br><br>            <span class="hljs-keyword">def</span> <span class="hljs-title function_">reorder_for_init</span>(<span class="hljs-params">row</span>):<br>                <span class="hljs-keyword">return</span> [row[row_pos] <span class="hljs-keyword">for</span> row_pos <span class="hljs-keyword">in</span> pos_list]<br>            <span class="hljs-variable language_">self</span>.reorder_for_init = reorder_for_init<br><br>        <span class="hljs-variable language_">self</span>.model_cls = klass_info[<span class="hljs-string">&#x27;model&#x27;</span>]<br>        <span class="hljs-variable language_">self</span>.pk_idx = <span class="hljs-variable language_">self</span>.init_list.index(<span class="hljs-variable language_">self</span>.model_cls._meta.pk.attname)<br>        <span class="hljs-variable language_">self</span>.related_populators = get_related_populators(klass_info, select, <span class="hljs-variable language_">self</span>.db)<br>        <br>        <span class="hljs-comment"># è®¾ç½®ç¼“å­˜åç§°</span><br>        field = klass_info[<span class="hljs-string">&#x27;field&#x27;</span>]<br>        reverse = klass_info[<span class="hljs-string">&#x27;reverse&#x27;</span>]<br>        <span class="hljs-variable language_">self</span>.reverse_cache_name = <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> reverse:<br>            <span class="hljs-variable language_">self</span>.cache_name = field.remote_field.get_cache_name()<br>            <span class="hljs-variable language_">self</span>.reverse_cache_name = field.get_cache_name()<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>.cache_name = field.get_cache_name()<br>            <span class="hljs-keyword">if</span> field.unique:<br>                <span class="hljs-variable language_">self</span>.reverse_cache_name = field.remote_field.get_cache_name()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">populate</span>(<span class="hljs-params">self, row, from_obj</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;ä»æ•°æ®åº“è¡Œå¡«å……å…³è”å¯¹è±¡&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.reorder_for_init:<br>            obj_data = <span class="hljs-variable language_">self</span>.reorder_for_init(row)<br>        <span class="hljs-keyword">else</span>:<br>            obj_data = row[<span class="hljs-variable language_">self</span>.cols_start:<span class="hljs-variable language_">self</span>.cols_end]<br>            <br>        <span class="hljs-keyword">if</span> obj_data[<span class="hljs-variable language_">self</span>.pk_idx] <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            obj = <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">else</span>:<br>            obj = <span class="hljs-variable language_">self</span>.model_cls.from_db(<span class="hljs-variable language_">self</span>.db, <span class="hljs-variable language_">self</span>.init_list, obj_data)<br>            <br>        <span class="hljs-comment"># é€’å½’å¤„ç†åµŒå¥—çš„å…³è”å¯¹è±¡</span><br>        <span class="hljs-keyword">if</span> obj <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.related_populators:<br>            <span class="hljs-keyword">for</span> rel_iter <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.related_populators:<br>                rel_iter.populate(row, obj)<br>                <br>        <span class="hljs-comment"># è®¾ç½®å…³è”å¯¹è±¡åˆ°ä¸»å¯¹è±¡ä¸Š</span><br>        <span class="hljs-built_in">setattr</span>(from_obj, <span class="hljs-variable language_">self</span>.cache_name, obj)<br>        <span class="hljs-keyword">if</span> obj <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.reverse_cache_name:<br>            <span class="hljs-built_in">setattr</span>(obj, <span class="hljs-variable language_">self</span>.reverse_cache_name, from_obj)<br></code></pre></td></tr></table></figure>

<h3 id="5-2-prefetch-related-æœºåˆ¶"><a href="#5-2-prefetch-related-æœºåˆ¶" class="headerlink" title="5.2 prefetch_related æœºåˆ¶"></a>5.2 prefetch_related æœºåˆ¶</h3><p>prefetch_related é€šè¿‡å•ç‹¬çš„æŸ¥è¯¢æ¥è·å–å…³è”å¯¹è±¡ï¼Œç„¶ååœ¨ Python ä¸­è¿›è¡Œå…³è”ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">prefetch_related_objects</span>(<span class="hljs-params">model_instances, *related_lookups</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    ä¸ºæ¨¡å‹å®ä¾‹åˆ—è¡¨å¡«å……é¢„å–çš„å¯¹è±¡ç¼“å­˜ï¼ŒåŸºäºç»™å®šçš„æŸ¥æ‰¾/Prefetch å®ä¾‹ã€‚</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(model_instances) == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span>  <span class="hljs-comment"># æ²¡æœ‰ä»€ä¹ˆå¯åšçš„</span><br><br>    related_lookups = normalize_prefetch_lookups(related_lookups)<br>    <br>    <span class="hljs-comment"># éœ€è¦èƒ½å¤ŸåŠ¨æ€æ·»åŠ åˆ°æˆ‘ä»¬æŸ¥æ‰¾çš„ prefetch_related æŸ¥æ‰¾åˆ—è¡¨ä¸­</span><br>    done_queries = &#123;&#125;    <span class="hljs-comment"># ç±»ä¼¼ &#x27;foo__bar&#x27;: [results] çš„å­—å…¸</span><br>    auto_lookups = <span class="hljs-built_in">set</span>()  <span class="hljs-comment"># æˆ‘ä»¬åœ¨è¿›è¡Œè¿‡ç¨‹ä¸­æ·»åŠ åˆ°è¿™é‡Œ</span><br>    followed_descriptors = <span class="hljs-built_in">set</span>()  <span class="hljs-comment"># é€’å½’ä¿æŠ¤</span><br><br>    all_lookups = deque(related_lookups)<br>    <span class="hljs-keyword">while</span> all_lookups:<br>        lookup = all_lookups.popleft()<br>        <span class="hljs-keyword">if</span> lookup.prefetch_to <span class="hljs-keyword">in</span> done_queries:<br>            <span class="hljs-keyword">if</span> lookup.queryset:<br>                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;&#x27;%s&#x27; lookup was already seen with a different queryset. &quot;</span><br>                                 <span class="hljs-string">&quot;You may need to adjust the ordering of your lookups.&quot;</span> % lookup.prefetch_to)<br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-comment"># é¡¶å±‚ï¼Œè¦è£…é¥°çš„å¯¹è±¡åˆ—è¡¨æ˜¯ä¸» QuerySet çš„ç»“æœç¼“å­˜</span><br>        obj_list = model_instances<br>        <br>        <span class="hljs-comment"># å¤„ç†æŸ¥æ‰¾è·¯å¾„çš„æ¯ä¸ªéƒ¨åˆ†</span><br>        through_attrs = lookup.prefetch_through.split(LOOKUP_SEP)<br>        <span class="hljs-keyword">for</span> level, through_attr <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(through_attrs):<br>            <span class="hljs-comment"># ... å¤æ‚çš„é¢„å–é€»è¾‘</span><br>            <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure>

<h2 id="6-å®æˆ˜æ¡ˆä¾‹åˆ†æ"><a href="#6-å®æˆ˜æ¡ˆä¾‹åˆ†æ" class="headerlink" title="6. å®æˆ˜æ¡ˆä¾‹åˆ†æ"></a>6. å®æˆ˜æ¡ˆä¾‹åˆ†æ</h2><h3 id="6-1-åŸºç¡€ç”¨æ³•ç¤ºä¾‹"><a href="#6-1-åŸºç¡€ç”¨æ³•ç¤ºä¾‹" class="headerlink" title="6.1 åŸºç¡€ç”¨æ³•ç¤ºä¾‹"></a>6.1 åŸºç¡€ç”¨æ³•ç¤ºä¾‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ç¤ºä¾‹æ¨¡å‹</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(models.Model):<br>    name = models.CharField(max_length=<span class="hljs-number">100</span>)<br>    age = models.IntegerField()<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Post</span>(models.Model):<br>    title = models.CharField(max_length=<span class="hljs-number">200</span>)<br>    author = models.ForeignKey(User, on_delete=models.CASCADE)<br><br><span class="hljs-comment"># æƒ°æ€§åŠ è½½ç¤ºä¾‹</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">lazy_loading_example</span>():<br>    <span class="hljs-comment"># 1. åˆ›å»º QuerySet - æƒ°æ€§çš„ï¼Œä¸æ‰§è¡ŒæŸ¥è¯¢</span><br>    qs = User.objects.<span class="hljs-built_in">filter</span>(age__gt=<span class="hljs-number">18</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;QuerySet å·²åˆ›å»ºï¼Œä½†æœªæ‰§è¡ŒæŸ¥è¯¢&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;QuerySet._result_cache: <span class="hljs-subst">&#123;qs._result_cache&#125;</span>&quot;</span>)  <span class="hljs-comment"># None</span><br>    <br>    <span class="hljs-comment"># 2. é“¾å¼æ“ä½œ - ä»ç„¶æƒ°æ€§çš„</span><br>    qs = qs.<span class="hljs-built_in">filter</span>(name__startswith=<span class="hljs-string">&#x27;A&#x27;</span>).order_by(<span class="hljs-string">&#x27;id&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ·»åŠ äº†æ›´å¤šè¿‡æ»¤æ¡ä»¶ï¼Œä»æœªæ‰§è¡ŒæŸ¥è¯¢&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;QuerySet._result_cache: <span class="hljs-subst">&#123;qs._result_cache&#125;</span>&quot;</span>)  <span class="hljs-comment"># ä»ç„¶æ˜¯ None</span><br>    <br>    <span class="hljs-comment"># 3. è§¦å‘æ±‚å€¼çš„æ“ä½œ</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ç°åœ¨å¼€å§‹æ‰§è¡ŒæŸ¥è¯¢...&quot;</span>)<br>    <br>    <span class="hljs-comment"># æ–¹å¼1ï¼šè¿­ä»£è§¦å‘</span><br>    <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> qs:  <span class="hljs-comment"># è¿™é‡Œè§¦å‘ __iter__ -&gt; _fetch_all</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;User: <span class="hljs-subst">&#123;user.name&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;QuerySet._result_cache: <span class="hljs-subst">&#123;qs._result_cache <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>&#125;</span>&quot;</span>)  <span class="hljs-comment"># True</span><br>    <br>    <span class="hljs-comment"># æ–¹å¼2ï¼šé•¿åº¦è®¡ç®—è§¦å‘ï¼ˆä½¿ç”¨ç¼“å­˜ï¼Œä¸ä¼šé‡æ–°æŸ¥è¯¢ï¼‰</span><br>    count = <span class="hljs-built_in">len</span>(qs)  <span class="hljs-comment"># ä½¿ç”¨å·²ç¼“å­˜çš„ç»“æœ</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Count: <span class="hljs-subst">&#123;count&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-comment"># æ–¹å¼3ï¼šå¸ƒå°”å€¼åˆ¤æ–­ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰</span><br>    <span class="hljs-keyword">if</span> qs:  <span class="hljs-comment"># ä½¿ç”¨å·²ç¼“å­˜çš„ç»“æœ</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æœ‰æ•°æ®&quot;</span>)<br></code></pre></td></tr></table></figure>

<h3 id="6-2-æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹"><a href="#6-2-æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹" class="headerlink" title="6.2 æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹"></a>6.2 æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">optimization_examples</span>():<br>    <span class="hljs-comment"># âŒ N+1 æŸ¥è¯¢é—®é¢˜</span><br>    posts = Post.objects.<span class="hljs-built_in">all</span>()<br>    <span class="hljs-keyword">for</span> post <span class="hljs-keyword">in</span> posts:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;post.title&#125;</span> by <span class="hljs-subst">&#123;post.author.name&#125;</span>&quot;</span>)  <span class="hljs-comment"># æ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“</span><br>    <br>    <span class="hljs-comment"># âœ… ä½¿ç”¨ select_related ä¼˜åŒ– å®ç°åŸç†å°±æ˜¯æŠŠuserå’Œbookè¿›è¡Œinner joinäº†</span><br>    posts = Post.objects.select_related(<span class="hljs-string">&#x27;author&#x27;</span>).<span class="hljs-built_in">all</span>()<br>    <span class="hljs-keyword">for</span> post <span class="hljs-keyword">in</span> posts:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;post.title&#125;</span> by <span class="hljs-subst">&#123;post.author.name&#125;</span>&quot;</span>)  <span class="hljs-comment"># åªæŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“</span><br>    <br>    <span class="hljs-comment"># âœ… å¤§æ•°æ®é›†çš„å†…å­˜ä¼˜åŒ–</span><br>    <span class="hljs-comment"># æ–¹å¼1ï¼šä½¿ç”¨ iteratorï¼Œä½å†…å­˜å ç”¨</span><br>    <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> User.objects.<span class="hljs-built_in">all</span>().iterator():<br>        process_user(user)<br>    <br>    <span class="hljs-comment"># æ–¹å¼2ï¼šåˆ†æ‰¹å¤„ç†</span><br>    batch_size = <span class="hljs-number">1000</span><br>    <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> User.objects.<span class="hljs-built_in">all</span>().iterator(chunk_size=batch_size):<br>        process_user(user)<br></code></pre></td></tr></table></figure>

<h3 id="6-3-åˆ‡ç‰‡æ“ä½œçš„æƒ°æ€§ç‰¹æ€§"><a href="#6-3-åˆ‡ç‰‡æ“ä½œçš„æƒ°æ€§ç‰¹æ€§" class="headerlink" title="6.3 åˆ‡ç‰‡æ“ä½œçš„æƒ°æ€§ç‰¹æ€§"></a>6.3 åˆ‡ç‰‡æ“ä½œçš„æƒ°æ€§ç‰¹æ€§</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">slicing_examples</span>():<br>    <span class="hljs-comment"># åˆ‡ç‰‡æ“ä½œä»ç„¶ä¿æŒæƒ°æ€§</span><br>    qs = User.objects.<span class="hljs-built_in">filter</span>(age__gt=<span class="hljs-number">18</span>)<br>    <br>    <span class="hljs-comment"># è·å–å‰10ä¸ªç”¨æˆ· - åˆ›å»ºæ–°çš„ QuerySetï¼Œæ·»åŠ  LIMIT 10</span><br>    first_10 = qs[:<span class="hljs-number">10</span>]  <span class="hljs-comment"># ä»ç„¶æƒ°æ€§ï¼Œæœªæ‰§è¡ŒæŸ¥è¯¢</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;first_10._result_cache: <span class="hljs-subst">&#123;first_10._result_cache&#125;</span>&quot;</span>)  <span class="hljs-comment"># None</span><br>    <br>    <span class="hljs-comment"># åªæœ‰åœ¨å®é™…ä½¿ç”¨æ—¶æ‰æ‰§è¡ŒæŸ¥è¯¢</span><br>    users = <span class="hljs-built_in">list</span>(first_10)  <span class="hljs-comment"># ç°åœ¨æ‰§è¡ŒæŸ¥è¯¢ï¼ŒSQL åŒ…å« LIMIT 10</span><br>    <br>    <span class="hljs-comment"># è·å–å•ä¸ªç”¨æˆ·</span><br>    first_user = qs[<span class="hljs-number">0</span>]  <span class="hljs-comment"># åˆ›å»º LIMIT 1 çš„æŸ¥è¯¢å¹¶ç«‹å³æ‰§è¡Œ</span><br></code></pre></td></tr></table></figure>

<h2 id="7-æ€»ç»“"><a href="#7-æ€»ç»“" class="headerlink" title="7. æ€»ç»“"></a>7. æ€»ç»“</h2><h3 id="7-1-æ ¸å¿ƒè®¾è®¡åŸåˆ™"><a href="#7-1-æ ¸å¿ƒè®¾è®¡åŸåˆ™" class="headerlink" title="7.1 æ ¸å¿ƒè®¾è®¡åŸåˆ™"></a>7.1 æ ¸å¿ƒè®¾è®¡åŸåˆ™</h3><ol>
<li><strong>æƒ°æ€§æ±‚å€¼</strong>ï¼šå»¶è¿Ÿæ‰§è¡Œç›´åˆ°çœŸæ­£éœ€è¦æ•°æ®</li>
<li><strong>ä¸å¯å˜æ€§</strong>ï¼šQuerySet æ“ä½œè¿”å›æ–°å¯¹è±¡ï¼Œä¿æŒåŸå¯¹è±¡ä¸å˜</li>
<li><strong>ç¼“å­˜æœºåˆ¶</strong>ï¼šé¿å…é‡å¤çš„æ•°æ®åº“æŸ¥è¯¢</li>
<li><strong>å†…å­˜æ•ˆç‡</strong>ï¼šæ”¯æŒå¤§æ•°æ®é›†çš„æµå¼å¤„ç†</li>
</ol>
<h3 id="7-2-å…³é”®æŠ€æœ¯ç‚¹"><a href="#7-2-å…³é”®æŠ€æœ¯ç‚¹" class="headerlink" title="7.2 å…³é”®æŠ€æœ¯ç‚¹"></a>7.2 å…³é”®æŠ€æœ¯ç‚¹</h3><ul>
<li><code>_result_cache</code> æ§åˆ¶æŸ¥è¯¢æ‰§è¡Œå’Œç»“æœç¼“å­˜</li>
<li><code>_fetch_all</code> æ˜¯æƒ°æ€§åŠ è½½çš„æ ¸å¿ƒå…¥å£</li>
<li><code>ModelIterable</code> ä½¿ç”¨ç”Ÿæˆå™¨æ¨¡å¼å¤„ç†æ•°æ®è¡Œ</li>
<li><code>RelatedPopulator</code> ä¼˜åŒ–å…³è”å¯¹è±¡çš„åŠ è½½</li>
<li>å¤šå±‚è¿­ä»£å™¨æ¶æ„æ”¯æŒçµæ´»çš„æ•°æ®å¤„ç†</li>
</ul>
<h3 id="7-3-æ€§èƒ½ä¼˜åŒ–å»ºè®®"><a href="#7-3-æ€§èƒ½ä¼˜åŒ–å»ºè®®" class="headerlink" title="7.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®"></a>7.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®</h3><ol>
<li><strong>åˆç†ä½¿ç”¨ select_related</strong>ï¼šé¿å… N+1 æŸ¥è¯¢é—®é¢˜</li>
<li><strong>å¤§æ•°æ®é›†ä½¿ç”¨ iterator</strong>ï¼šé™ä½å†…å­˜ä½¿ç”¨</li>
<li><strong>é¿å…ä¸å¿…è¦çš„æ±‚å€¼</strong>ï¼šä¿æŒ QuerySet çš„æƒ°æ€§ç‰¹æ€§</li>
<li><strong>é‡ç”¨ QuerySet å¯¹è±¡</strong>ï¼šåˆ©ç”¨ç»“æœç¼“å­˜æœºåˆ¶</li>
</ol>
<h3 id="7-4-å­¦ä¹ è¦ç‚¹"><a href="#7-4-å­¦ä¹ è¦ç‚¹" class="headerlink" title="7.4 å­¦ä¹ è¦ç‚¹"></a>7.4 å­¦ä¹ è¦ç‚¹</h3><ul>
<li>ç†è§£æƒ°æ€§åŠ è½½çš„è§¦å‘æ—¶æœº</li>
<li>æŒæ¡ QuerySet çš„çŠ¶æ€å˜åŒ–è¿‡ç¨‹</li>
<li>ç†Ÿæ‚‰å„ç§ä¼˜åŒ–æŠ€æœ¯çš„ä½¿ç”¨åœºæ™¯</li>
<li>å…³æ³¨å†…å­˜ä½¿ç”¨å’ŒæŸ¥è¯¢æ•ˆç‡çš„å¹³è¡¡</li>
</ul>
<p>Django QuerySet çš„è®¾è®¡æ˜¯ç°ä»£ ORM æ¡†æ¶çš„å…¸å‹ä»£è¡¨ï¼Œé€šè¿‡å·§å¦™çš„æƒ°æ€§åŠ è½½æœºåˆ¶ï¼Œåœ¨æä¾›ç®€æ´ API çš„åŒæ—¶ä¿è¯äº†è‰¯å¥½çš„æ€§èƒ½ç‰¹æ€§ã€‚æ·±å…¥ç†è§£å…¶å®ç°åŸç†ï¼Œæœ‰åŠ©äºæˆ‘ä»¬æ›´å¥½åœ°ä½¿ç”¨ Django ORMï¼Œç¼–å†™é«˜æ•ˆçš„æ•°æ®åº“æŸ¥è¯¢ä»£ç ã€‚</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Django/" class="print-no-link">#Django</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Django QuerySet</div>
      <div>https://luffy997.github.io/2025/07/27/Django-QuerySet/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Luffy997</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2025å¹´7æœˆ27æ—¥</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/07/27/Django-ORM/" title="Django ORM">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Django ORM</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/07/22/Django-%E4%BA%8B%E5%8A%A1/" title="Django äº‹åŠ¡">
                        <span class="hidden-mobile">Django äº‹åŠ¡</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
